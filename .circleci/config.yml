version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2
  slack: circleci/slack@3.4.2

commands:
  set_slack_message:
    steps:
    - run:
        name: Slack - Generating Custom Message
        command: bash .circleci/generate-slack-message.sh
  configure_bundler:
    steps:
    - run:
        name: Configure Bundler
        command: bash .circleci/configure-bundler.sh
    - restore_cache:
        key: bundler-cache-{{ checksum "Gemfile.lock" }}
    - run:
        name: Bundle Install
        command: bundle install --path vendor/bundle
    - save_cache:
        key: bundler-cache-{{ checksum "Gemfile.lock" }}
        paths: [ vendor/bundle ]
  jekyll_build:
    steps:
    - run:
        name: Jekyll Build
        command: JEKYLL_ENV=production bundle exec jekyll build --destination ./site
  html_proofer:
    steps:
    - run:
        name: HTML Proofer
        command: bash .circleci/html-proofer.sh || echo "HTML Proofer failed. Please investigate the failures."
  github_pages_deploy:
    steps:
    - add_ssh_keys:
        fingerprints: [ d3:10:c9:11:e9:8b:7f:09:ce:29:d5:38:81:da:ef:bb ]
    - deploy:
        name: Deploy to GitHub Pages
        command: bash .circleci/github-pages-deploy.sh
  slack_build_notification:
    steps:
    - slack/status:
        success_message: "$SLACK_MESSAGE passed."
        failure_message: "$SLACK_MESSAGE failed."
        include_job_number_field: false
        include_project_field: false
  slack_deploy_notification:
    steps:
    - slack/status:
        success_message: "$SLACK_MESSAGE passed.\n$DEPLOY_MESSAGE."
        failure_message: "$SLACK_MESSAGE failed.\nUnable to deploy to GitHub Pages."
        include_job_number_field: false
        include_project_field: false

jobs:
  test:
    working_directory: ~/emma-sax4.github.io
    docker: [ image: circleci/ruby:2.6.5 ]
    steps:
    - checkout
    - set_slack_message
    - configure_bundler
    - jekyll_build
    - html_proofer
    - slack_build_notification
  test_and_deploy:
    working_directory: ~/emma-sax4.github.io
    docker: [ image: circleci/ruby:2.6.5 ]
    steps:
    - checkout
    - set_slack_message
    - configure_bundler
    - jekyll_build
    - html_proofer
    - github_pages_deploy
    - slack_deploy_notification

workflows:
  version: 2
  develop:
    jobs:
    - test:
        filters:
          branches:
            ignore: [ release ]
  release:
    jobs:
    - test_and_deploy:
        filters:
          branches:
            only: [ release ]
  cron:
    jobs: [ test_and_deploy ]
    triggers:
    - schedule:
        cron: "0 6 * * *" # 06:00 UTC => 00:00 CST
        filters:
          branches:
            only: [ release ]
    - schedule:
        cron: "0 18 * * *" # 18:00 UTC => 12:00 CST
        filters:
          branches:
            only: [ release ]
